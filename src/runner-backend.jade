link(rel="import", href="dep/core-ajax/core-ajax.html")
link(rel="import", href="dep/core-localstorage/core-localstorage.html")

polymer-element(name="runner-backend", \attributes="addTrack, tracks, trackToDelete, saveTracks")
  template
    core-ajax( id="saveTracks", url="http://jsonip.com/", handleAs="json", params="{{tracksParams(tracks)}}", method="POST")
    //- core-ajax( id="saveTracks", url="http://jsonip.com/", handleAs="json", params="{{tracks}}", method="POST")
    //- core-ajax( id="saveTracks", url="http://jsonip.com/", handleAs="json", params="{\"tracks\": {{tracks}}", method="POST")
    core-localstorage( id="store", name="tracks", value="{{tracks}}")
  script.
    Polymer('runner-backend',{
      saveTracks:false,
      ready:function(){
        this.$.saveTracks.addEventListener("core-response",function(){
          this.fire("runner-tracks-saved");
        },this);
        //- this.$.saveTracks.addEventListener("core-error",function(){},this);
        //- this.$.saveTracks.addEventListener("core-complete",function(){},this);
      },
      tracksParams:function(){
        var params =  {
          tracks: this.tracks
        };
        return JSON.stringify(params);
        //- return params;
      },
      addTrack:function(track){
        this.tracks.push(track);
        this.$.store.save();
      },
      trackToDeleteChanged:function(){
        var newTracks = this.tracks.filter(function(track, index){
          return index !== this.trackToDelete;
        }, this);
        this.trackToDelete = null;
        this.tracks = newTracks;
      },
      saveTracksChanged:function(){
        if(!this.saveTracks){return}
        this.fire("runner-tracks-saving");
        //- this.$.saveTracks.params = JSON.stringify({
        //-   tracks:this.tracks
        //- });
        //- this.$.saveTracks.params = {
        //-   tracks:this.tracks
        //- };
        this.$.saveTracks.go();
        this.saveTracks = false
      },
      ready:function(){
        this.$.store.load();
        this.tracks = this.tracks || [];
        this.$.store.save();
      }
    })
